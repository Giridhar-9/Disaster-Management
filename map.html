<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Earth - Weather, Disasters, Drought</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }

    #cesiumContainer {
      position: absolute;
      top: 70px;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
    }

    nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 70px;
      background-color: #0d1117;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      color: white;
    }

    .navCon1 {
      display: flex;
      align-items: center;
      gap: 30px;
    }

    .VSnav h3 {
      margin: 0;
      font-size: 20px;
      cursor: pointer;
    }

    .navLinks a {
      color: white;
      margin-right: 20px;
      text-decoration: none;
      font-weight: 500;
    }

    .navLinks a:hover {
      text-decoration: underline;
    }

    .navCon2 .download {
      background-color: #d73a49;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: white;
      color: black;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 1000;
      line-height: 1.6;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    }

    .legend span {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 6px;
      border-radius: 3px;
    }

    #gpsButton {
      position: fixed;
      top: 80px;
      left: 20px;
      z-index: 1000;
      background-color: #1f6feb;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <nav>
    <div class="navCon1">
      <div class="VSnav">
        <h3 onclick="window.open('index.html','_self')">CrisisGuard</h3>
      </div>
      <div class="navLinks">
        <a href="index.html">Home</a>
        <a onclick="window.open('news.html', '_blank')">News</a>
        <a onclick="window.open('measures.html', '_blank')">Precautions</a>
        <a href="#">Map</a>
      </div>
    </div>
    <div class="navCon2">
      <button class="download" onclick="window.open('login.html', '_blank')">Rescue</button>
    </div>
  </nav>

  <button id="gpsButton">üìç GPS</button>

  <div id="cesiumContainer"></div>

  <div class="legend">
    <strong>Legend</strong><br>
    <span style="background:red;"></span> Earthquake<br>
    <span style="background:orange;"></span> Wildfire<br>
    <span style="background:lightblue;"></span> Rain<br>
    <span style="background:blue;"></span> Clouds<br>
    <span style="background:green;"></span> Windy<br>
    <span style="background:purple;"></span> Thunderstorm<br>
    <span style="background:yellow;"></span> Drought<br>
  </div>

  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzNDA5MjQ2Yi02YWMwLTRlNDMtODdmZC0wZmYzMTM3MGU4ZjAiLCJpZCI6MjkzNDEzLCJpYXQiOjE3NDQ0NTQzMjZ9.iwVAVMqR7F1jpeORAEZpG2-7IWcs_X063naaD70S1Uw';
    const OPENWEATHERMAP_KEY = '94dcbaa4e75b1671410a6606a9684470';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: Cesium.createWorldTerrain(),
      shouldAnimate: true,
      baseLayerPicker: true
    });

    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(0, 20, 20000000)
    });

    // Earthquakes
    fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson')
      .then(res => res.json())
      .then(data => {
        data.features.forEach(eq => {
          const [lon, lat] = eq.geometry.coordinates;
          const mag = eq.properties.mag;
          const place = eq.properties.place;

          if (!isNaN(mag) && !isNaN(lat) && !isNaN(lon)) {
            viewer.entities.add({
              position: Cesium.Cartesian3.fromDegrees(lon, lat),
              ellipse: {
                semiMinorAxis: Math.max(mag * 10000, 5000),
                semiMajorAxis: Math.max(mag * 10000, 5000),
                material: Cesium.Color.RED.withAlpha(0.5)
              },
              description: `üåç <b>Earthquake</b><br>Magnitude: ${mag}<br>${place}`
            });
          }
        });
      });

    // Wildfires
    fetch('https://firms.modaps.eosdis.nasa.gov/data/active_fire/c6/csv/MODIS_C6_Global_24h.csv')
      .then(res => res.text())
      .then(text => {
        const rows = text.trim().split('\n').slice(1);
        rows.forEach(row => {
          const [lat, lon] = row.split(',').map(Number);
          if (!isNaN(lat) && !isNaN(lon)) {
            viewer.entities.add({
              position: Cesium.Cartesian3.fromDegrees(lon, lat),
              point: {
                pixelSize: 6,
                color: Cesium.Color.ORANGE.withAlpha(0.7)
              },
              description: "üî• <b>Wildfire</b>"
            });
          }
        });
      });

    // Predefined Weather Locations
    const weatherLocations = [
      { lat: 51.5, lon: -0.1, name: "London" },
      { lat: 40.7, lon: -74.0, name: "New York" },
      { lat: 35.6, lon: 139.6, name: "Tokyo" },
      { lat: 28.6, lon: 77.2, name: "Delhi" }
    ];

    weatherLocations.forEach(loc => {
      fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${loc.lat}&lon=${loc.lon}&appid=${OPENWEATHERMAP_KEY}&units=metric`)
        .then(res => res.json())
        .then(data => {
          const weather = data.weather[0].main;
          const windSpeed = data.wind.speed;
          const temp = data.main.temp;

          let color = Cesium.Color.BLUE;
          if (weather.toLowerCase().includes("rain")) color = Cesium.Color.LIGHTBLUE;
          else if (weather.toLowerCase().includes("thunderstorm")) color = Cesium.Color.PURPLE;
          else if (windSpeed > 6) color = Cesium.Color.GREEN;

          viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(loc.lon, loc.lat),
            ellipse: {
              semiMinorAxis: 15000,
              semiMajorAxis: 15000,
              material: color.withAlpha(0.5)
            },
            description: `üå§Ô∏è <b>${loc.name}</b><br>Weather: ${weather}<br>Temp: ${temp}¬∞C<br>Wind: ${windSpeed} m/s`
          });
        });
    });

    // On map click - show weather
    viewer.screenSpaceEventHandler.setInputAction(function (click) {
      const cartesian = viewer.camera.pickEllipsoid(click.position, viewer.scene.globe.ellipsoid);
      if (cartesian) {
        const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
        const lat = Cesium.Math.toDegrees(cartographic.latitude);
        const lon = Cesium.Math.toDegrees(cartographic.longitude);

        fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHERMAP_KEY}&units=metric`)
          .then(res => res.json())
          .then(data => {
            const weather = data.weather[0].main;
            const windSpeed = data.wind.speed;
            const city = data.name || 'Selected Area';
            const temp = data.main.temp;

            let color = Cesium.Color.BLUE;
            if (weather.toLowerCase().includes("rain")) color = Cesium.Color.LIGHTBLUE;
            else if (weather.toLowerCase().includes("thunderstorm")) color = Cesium.Color.PURPLE;
            else if (windSpeed > 6) color = Cesium.Color.GREEN;

            viewer.entities.add({
              position: Cesium.Cartesian3.fromDegrees(lon, lat),
              ellipse: {
                semiMinorAxis: 15000,
                semiMajorAxis: 15000,
                material: color.withAlpha(0.5)
              },
              description: `üå§Ô∏è <b>${city}</b><br>Weather: ${weather}<br>Temp: ${temp}¬∞C<br>Wind: ${windSpeed} m/s`
            });
          });
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // Drought Regions
    const droughtRegions = [
      { lat: 28.6, lon: 77.2, region: "Delhi, India" },
      { lat: 35.7, lon: -119.4, region: "California, USA" },
      { lat: -33.9, lon: 18.4, region: "Cape Town, South Africa" }
    ];

    droughtRegions.forEach(d => {
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(d.lon, d.lat),
        ellipse: {
          semiMinorAxis: 40000,
          semiMajorAxis: 40000,
          material: Cesium.Color.YELLOW.withAlpha(0.4)
        },
        description: `üåæ <b>Drought Region</b><br>${d.region}`
      });
    });

    // GPS Button - fly closer to user's location
    document.getElementById("gpsButton").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(lon, lat, 50000)
          });

          fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHERMAP_KEY}&units=metric`)
            .then(res => res.json())
            .then(data => {
              const weather = data.weather[0].main;
              const windSpeed = data.wind.speed;
              const city = data.name || 'Your Location';
              const temp = data.main.temp;

              let color = Cesium.Color.BLUE;
              if (weather.toLowerCase().includes("rain")) color = Cesium.Color.LIGHTBLUE;
              else if (weather.toLowerCase().includes("thunderstorm")) color = Cesium.Color.PURPLE;
              else if (windSpeed > 6) color = Cesium.Color.GREEN;

              viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(lon, lat),
                ellipse: {
                  semiMinorAxis: 15000,
                  semiMajorAxis: 15000,
                  material: color.withAlpha(0.5)
                },
                description: `üìç <b>${city}</b><br>Weather: ${weather}<br>Temp: ${temp}¬∞C<br>Wind: ${windSpeed} m/s`
              });
            });
        }, () => {
          alert("Location access denied.");
        });
      } else {
        alert("Geolocation not supported.");
      }
    });
  </script>

</body>

</html>
